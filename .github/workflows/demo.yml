name: demo

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Action (deploy|rollback|scan|report)"
        required: true
        default: "scan"
      args:
        description: "Args as JSON object (e.g. {\"env\":\"dev\"})"
        required: false
        default: "{}"
      request_id:
        description: "Request ID"
        required: false
  repository_dispatch:
    types: [dispatch]

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: show payload
        run: |
          echo "event: ${{ github.event_name }}"
          echo "type:  ${{ github.event.action }}"
          echo "payload:"
          echo '${{ toJson(github.event.client_payload) }}'

      - name: validate action allowlist
        shell: bash
        run: |
          ACTION='${{ github.event.client_payload.action }}'
          ENV='${{ github.event.client_payload.env }}'
          REQ='${{ github.event.client_payload.request_id }}'

          echo "action=$ACTION env=$ENV request_id=$REQ"

          case "$ACTION" in
            ping|deploy|rollback) ;;
            *) echo "ERROR: action not allowed: $ACTION"; exit 1 ;;
          esac

          case "$ENV" in
            dev|staging|prod) ;;
            *) echo "ERROR: env not allowed: $ENV"; exit 1 ;;
          esac

      - name: simulate action
        shell: bash
        run: |
          ACTION='${{ github.event.client_payload.action }}'
          ENV='${{ github.event.client_payload.env }}'

          if [ "$ACTION" = "ping" ]; then
            echo "pong"
          elif [ "$ACTION" = "deploy" ]; then
            echo "SIMULATE deploy to $ENV"
          elif [ "$ACTION" = "rollback" ]; then
            echo "SIMULATE rollback on $ENV"
          fi

      - name: Call gateway (v1 format)
        if: ${{ github.event.client_payload.action != 'ping' || github.event_name == 'workflow_dispatch' }}
        env:
          GATEWAY_URL: https://actions-gateway-worker.f547x1.workers.dev
          API_KEY: ${{ secrets.ACTIONS_GATEWAY_API_KEY }}
          V1_ACTION: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.action || github.event.inputs.action }}
          V1_REQ_ID: ${{ github.event.client_payload.request_id || github.event.inputs.request_id || format('req-{0}', github.run_id) }}
          V1_ARGS_REPO: ${{ github.event_name == 'repository_dispatch' && toJson({ env: github.event.client_payload.env }) || '{}' }}
          V1_ARGS_INPUT: ${{ github.event.inputs.args }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          if [ "$EVENT_NAME" = "repository_dispatch" ]; then
            V1_ARGS="$V1_ARGS_REPO"
          else
            V1_ARGS="${V1_ARGS_INPUT:-{}}"
          fi
          BODY=$(printf '{"action":"%s","args":%s,"request_id":"%s"}' "$V1_ACTION" "$V1_ARGS" "$V1_REQ_ID")
          echo "POST $GATEWAY_URL/v1/dispatch (v1 format)"
          echo "body: $BODY"
          curl -sS -X POST "$GATEWAY_URL/v1/dispatch" \
            -H "x-api-key: $API_KEY" \
            -H "Content-Type: application/json" \
            -d "$BODY" | tee /tmp/gateway-resp.json
          if ! jq -e '.ok == true' /tmp/gateway-resp.json >/dev/null 2>&1; then
            echo "Gateway call failed"
            exit 1
          fi
          echo "Gateway responded OK"
